<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Leaflet Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
  </style>
</head>
<body>
    <div id="map" style="height: 100%; width: 100%;"></div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-geojson-vt"></script>
    <script>
        window.console.log = function(message) {
            if (window.javaConnector) {
                window.javaConnector.log(message);
            }
        };

        const customIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // Example custom icon URL
            iconSize: [25, 41], // Size of the icon
            iconAnchor: [12, 41], // Anchor point of the icon
            popupAnchor: [1, -34], // Position of the popup relative to the icon
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png', // Optional shadow
            shadowSize: [41, 41], // Size of the shadow
        });


        const map = L.map('map', {
            center: [(8.87899 + 8.89832) / 2, (38.79519 + 38.82888) / 2],
            zoom: 15,
            minZoom: 16, 
            maxZoom: 16,
            maxBounds: [
                [8.87899, 38.79519],     
                [8.89832, 38.82888]
            ],
            maxBoundsViscosity: 1.0
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const bounds = [
            [8.87899, 38.79519],     
            [8.89832, 38.82888]
        ];


        map.setMaxBounds(bounds);
        map.fitBounds(bounds);

        let startCoord = null;
        let markers = [];

        function onMapClick(e) {
            const { lat, lng } = e.latlng;

            if (!startCoord) {
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];

                startCoord = { lat, lng };
                const startMarker = L.marker([lat, lng]).addTo(map).bindPopup("Start Point").openPopup();
                
                markers.push(startMarker);

                if(window.javaGraph) {
                    const nearCoor = window.javaGraph.chk(lat, lng); 
                    const res = JSON.parse(nearCoor);
                    const nearStartMarker =  L.marker([res.lat, res.lon], { icon: customIcon }).addTo(map).bindPopup("Near Start Point").openPopup();
                    markers.push(nearStartMarker);
                    
                }

            } else {
                const endCoord = { lat, lng };
                const endMarker = L.marker([lat, lng]).addTo(map).bindPopup("End Point").openPopup();
                markers.push(endMarker);

                if (window.javaConnector) {
                    window.javaConnector.sendCoordinates(
                        JSON.stringify({ start: startCoord, end: endCoord })
                    );
                }

                if(window.javaGraph) {
                    const nearCoor = window.javaGraph.chk(lat, lng); 
                    const res = JSON.parse(nearCoor);
                    const nearEndMarker = L.marker([res.lat, res.lon], { icon: customIcon }).addTo(map).bindPopup("Near End Point").openPopup();
                    markers.push(nearEndMarker);
                    
                }
                

                startCoord = null;
            }
        }

        map.on('click', onMapClick);


        function loadGeoJson(geoJson) {
            console.log("data:" , JSON.stringify(geoJson, null, 2));
            const data = geoJson;
            L.geoJSON(data, {
                pointToLayer: function(feature, latlng) {
                    const marker = L.marker(latlng);
                    if( feature.properties && feature.properties.name){
                        marker.bindPopup(feature.properties.name);
                    }
                    return marker;
                }
                
            }).addTo(map);
        }
    </script>
</body>
</html>